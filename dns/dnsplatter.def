Bootstrap: docker
From: nvidia/cuda:11.8.0-devel-ubuntu22.04

%files
    /tudelft.net/staff-umbrella/Deep3D/mingchiehhu/dn-splatter /opt/dn-splatter

%post
    # --- 1. System Setup ---
    apt-get update
    apt-get install -y --no-install-recommends wget curl git build-essential 
    apt-get install -y --no-install-recommends unzip cmake ninja-build \
        libgl1 libgl1-mesa-glx libglib2.0-0 libsm6 libxrender1 libxext6 \
        libxi6 libx11-6 libegl1-mesa-dev libtiff5

    git config --system --add safe.directory '*'

    # Clean up apt cache to keep image small
    rm -rf /var/lib/apt/lists/*

    # --- 2. Install Miniconda ---
    CONDA_INSTALLER="Miniconda3-latest-Linux-x86_64.sh"
    wget https://repo.anaconda.com/miniconda/${CONDA_INSTALLER}
    bash ${CONDA_INSTALLER} -b -p /opt/conda
    rm ${CONDA_INSTALLER}

    export PATH="/opt/conda/bin:$PATH"
    export TORCH_CUDA_ARCH_LIST="7.0;7.5;8.0;8.6"

    # --- 3. Create Conda Environment ---
    /opt/conda/bin/conda tos accept
    /opt/conda/bin/conda create -n nerfstudio python=3.8 -y

    # --- 4. Use Conda Environment Directly ---
    # Define the specific path to the 'bin' folder of the new env
    ENV_BIN="/opt/conda/envs/nerfstudio/bin"
    
    # Use the conda environment's python/pip directly
    ${ENV_BIN}/pip install torch==2.1.2+cu118 torchvision==0.16.2+cu118 --extra-index-url https://download.pytorch.org/whl/cu118
    ${ENV_BIN}/pip install ninja
    # Install tiny-cuda-nn after PyTorch and ninja are available
    export TCNN_CUDA_ARCHITECTURES="70;75;80;86"
    ${ENV_BIN}/pip install git+https://github.com/NVlabs/tiny-cuda-nn/#subdirectory=bindings/torch
    /opt/conda/bin/conda install -n nerfstudio -y -c conda-forge "libtiff<4.5" pillow

    # --- 5. Install Submodules ---
    echo "Active Python: $(${ENV_BIN}/python --version)"
    echo "Active Pip: $(${ENV_BIN}/pip --version)"
    
    echo "Installing nerfstudio..."
    ${ENV_BIN}/pip install nerfstudio

    echo "Installing dn-splatter"
    cd /opt/dn-splatter/
    ${ENV_BIN}/pip install setuptools==69.5.1
    ${ENV_BIN}/pip install -e .

    # 6. Final Cleanup
    /opt/conda/bin/conda clean --all -y
    apt-get clean && rm -rf /var/lib/apt/lists/*
    cd /

%environment # Runtime variables
    export PATH="/opt/conda/envs/nerfstudio/bin:/opt/conda/bin:$PATH"
    export CONDA_DEFAULT_ENV="nerfstudio"
    export LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH" 

%runscript
    exec /bin/bash "$@"

%labels
    Author "MCHU"
    OS "Ubuntu 22.04"
    CUDA "11.8"